name: Deploy API to Azure Container Apps

on:
    push:
        branches: [main]
        paths:
            - "services/api/**"
            - ".github/workflows/api-container-apps.yml"
    workflow_dispatch:

env:
    DOTNET_VERSION: "8.0.x"
    REGISTRY_NAME: shancrysacrdevhp7owg
    IMAGE_NAME: shancrys-api
    CONTAINER_APP_NAME: shancrys-api
    RESOURCE_GROUP: shancrys-rg

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Log in to Azure
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Log in to Azure Container Registry
              run: |
                  az acr login --name ${{ env.REGISTRY_NAME }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: ./services/api
                  push: true
                  tags: |
                      ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
                      ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    deploy:
        runs-on: ubuntu-latest
        needs: build-and-push
        environment:
            name: "Production"

        steps:
            - name: Log in to Azure
              uses: azure/login@v2
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Deploy to Azure Container Apps
              run: |
                  az containerapp update \
                    --name ${{ env.CONTAINER_APP_NAME }} \
                    --resource-group ${{ env.RESOURCE_GROUP }} \
                    --image ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}

            - name: Get Container App URL
              id: get-url
              run: |
                  URL=$(az containerapp show \
                    --name ${{ env.CONTAINER_APP_NAME }} \
                    --resource-group ${{ env.RESOURCE_GROUP }} \
                    --query properties.configuration.ingress.fqdn \
                    --output tsv)
                  echo "url=https://$URL" >> $GITHUB_OUTPUT

            - name: Test deployment
              run: |
                  echo "API URL: ${{ steps.get-url.outputs.url }}"
                  curl -f ${{ steps.get-url.outputs.url }}/health || echo "Health check will be available after first deploy"
